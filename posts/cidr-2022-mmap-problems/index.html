<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? | Jian Zhang</title><meta name=keywords content><meta name=description content="依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。 Background MMAP Overview"><meta name=author content="Jian"><link rel=canonical href=https://zz-jason.github.io/posts/cidr-2022-mmap-problems/><link href=/assets/css/stylesheet.min.033f2f5bb33e007fdfa9d095ad28b97fbdc5b72f7f728306437836a43ffdb265.css integrity="sha256-Az8vW7M+AH/fqdCVrSi5f73Fty9/coMGQ3g2pD/9smU=" rel="preload stylesheet" as=style><link rel=icon href=https://zz-jason.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zz-jason.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zz-jason.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zz-jason.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zz-jason.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.110.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-67872953-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta property="og:title" content="[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?"><meta property="og:description" content="依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。 Background MMAP Overview"><meta property="og:type" content="article"><meta property="og:url" content="https://zz-jason.github.io/posts/cidr-2022-mmap-problems/"><meta property="article:published_time" content="2023-03-31T08:00:00+00:00"><meta property="article:modified_time" content="2023-03-31T08:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?"><meta name=twitter:description content="依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。 Background MMAP Overview"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zz-jason.github.io/posts/"},{"@type":"ListItem","position":2,"name":"[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?","item":"https://zz-jason.github.io/posts/cidr-2022-mmap-problems/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?","name":"[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?","description":"依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。 Background MMAP Overview","keywords":[],"articleBody":"依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。\nBackground MMAP Overview 使用 mmap 读写文件内容的步骤：\n程序调用 mmap，得到指向内存映射文件内容的内存指针 操作系统保留程序的虚拟地址空间的一部分，但不加载文件的任何部分 程序使用指针访问文件的内容 操作系统尝试检索页面 由于指定的虚拟地址没有有效的映射，因此操作系统会触发 page fault，将文件的引用部分从磁盘加载到物理内存页中 操作系统向 page table 添加一个条目，将虚拟地址映射到新的物理地址 当前的 CPU Core 将此条目缓存在其本地的 TLB 中，以加速将来的数据访问 Evict page 会出现一个叫 TLB Shootdown 的严重性能问题。操作系统需要从 page table 和每个 CPU Core 的 TLB 中删除它们的映射关系。清除触发中断的 CPU Core 的本地 TLB 很简单，但清除其他 CPU Core 上的 TLB 会很麻烦，因为当前 CPU 不为远端 TLB 提供一致性，操作系统必须发出昂贵的处理器间中断来刷新远端 CPU Core 的 TLB。从后面的实验结果能看到 TLB shootdown 会带来非常巨大的性能损失。\nPOSIX API mmap：这个调用会使操作系统将文件映射到 DBMS 的虚拟地址空间中，DBMS 可以使用普通的内存操作读写文件内容，通常使用下面两个 flag 来控制 update page 的行为：\nMAP_SHARED：操作系统会先将 page 缓存在内存中，由操作系统控制何时最终写回文件 MAP_PRIVATE：创建一个仅对调用者可访问的 copy-on-write 映射，page update 不会持久化到文件中。 madvise：使得 DBMS 可以向操作系统提供数据访问模式的 hint，可以是整个文件的粒度，也可以是特定 page 范围。《madvise(2) — Linux manual page》 列举了完整的 hint 和它们对应的功能。论文描述了三个常用的 hint：MADV_NORMAL、MADV_RANDOM 和 MADV_SEQUENTIAL\nMADV_NORMAL：默认 hint，它会获取访问的 page，以及它前 15 个和后 16 个 page。对于 4KB 的 page，即使调用者只请求单个 page，也会导致操作系统从磁盘中读取总共 128KB 的数据 MADV_RANDOM：只读必要的页面，对于大于内存的 OLTP workload 来说是更好的选择。MADV_SEQUENTIAL：预读给定范围内的页面，访问后不久可能被释放，对于具有顺序扫描的OLAP workload 来说会更好。 mlock：使得 DBMS 可以将 page 固定在内存中，确保操作系统永远不会将它们 evict 出内存。不过即使 page 被固定在内存中，操作系统也可以随时将脏页（修改后的 page）刷到文件中。DBMS 不能使用 mlock 来保证脏页永远不被持久化，误用可能带来事务正确性问题。\nmsync：显式地将指定的内存范围 flush 到文件。不显式调用 msync，DBMS 不能保证更新被持久化到文件中。\nMMAP Gone Wrong 上面是一些使用过（比如 MongoDB），或正在使用 mmap 作为 buffer manager（比如 LevelDB），或提供 mmap 作为 buffer manager 选项（比如 WiredTiger）的 database，作者还举了 MongoDB、InfluxDB、SingleStore 等几个使用 mmap 遇到问题的案例，这些故事比较有意思，有时间可以详细了解下。\nProblems With MMAP 主要是 4 个问题：transactional safety、I/O stalls、error handling，以及 performance issues。前面 3 个都能通过一些额外的稍显复杂的机制来解决或绕过，但性能问题除非修改操作系统内核代码否则无法有效避免。\nTransactional Safety 核心问题是：由于透明分页，操作系统可以在任何时候将脏页刷新到二级存储器中，而不管写入事务是否已提交。DBMS 无法阻止这些刷新，并在其发生时也不会收到任何警告。\n论文将解决办法分成了 3 种：OS copy-on-write、user space copy-on-write，以及 shadow paging。\nOS Copy-On-Write MongoDB 的 MMAPv1 存储引擎采用了这个策略。做法是：使用 mmap 和 MAP_PRIVATE flag 创建两个数据库文件副本，启用操作系统页面的写时复制功能，它们最初都指向相同的物理页面。第一个副本作为主副本，第二个副本则作为私有工作区供事务更新使用。当事务提交时，DBMS 将相应的 WAL 记录刷新到二级存储器，并使用单独的后台线程将提交的更改应用于主副本。\nOS copy-on-write 的问题：\n在允许冲突事务运行之前，DBMS 必须确保提交的事务的最新更新已传播到主副本，这需要额外的 bookkeeping 来跟踪待更新的页面。 随着更新的不断发生，私有工作区将持续增长，DBMS 最终可能会在内存中拥有两个完整的数据库副本。也有办法来解决这个问题，只是实现比较复杂，也会引入额外性能开销，这里不再详细描述。 User Space Copy-On-Write SQLite、MonetDB 和 RavenDB 采用了这个策略，做法是手动将受影响的页面从 mmap 的内存复制到用户空间中一个单独维护的内存 buffer 内。 在处理更新操作时，DBMS 仅将数据更新应用于单独维护的内存副本并创建相应的 WAL 记录。写完 WAL 即可提交事务，同时也将副本的页面复制到mmap的内存中，交给操作系统去刷盘。\nShadow Paging LMDB 基于 System R 的 shadow paging 设计采用了这种策略，做法是维护数据库的单独主副本和影子副本，这两个副本都由 mmap 支持。 处理更新操作时，DBMS 首先将受影响的页面从主副本复制到影子副本，然后应用更新操作。commit 更新操作需要使用 msync 将修改后的影子页面刷新到二级存储器，然后更新指针以将影子副本设置为新的主副本，原始主副本作为新的影子副本。\nShadow paging 需要注意的地方：必须确保事务不会冲突或看到部分更新。例如，LMDB 通过仅允许单个写入者来解决此问题。\nI/O Stalls mmap 不支持异步读取。因为 DBMS 无法知道页面是否在内存中，如果访问到已经驱逐的页面就会导致意外的 I/O 停顿。这一点和传统的 buffer manager 可以使用 libaio、io_uring 异步读写页面有很大不同。\n如何避免呢，其中一个思路是使用 mlock：用 mlock 来固定 DBMS 在不久的将来希望再次访问的页面。但使用 mlock 也是有限制的，因为固定太多页面可能会对并发运行的进程甚至操作系统本身造成一些严重问题，操作系统通常限制单个进程可以锁定的内存量。在这个限制下使用 mlock，DBMS 还需要仔细跟踪和取消固定不再使用的页面，以便操作系统可以驱逐它们。\n另一种思路是通过 madvise 告诉操作系统查询的读写模式。例如，需要执行顺序扫描的 DBMS 可以向 madvise 提供 MADV_SEQUENTIAL flag，告诉操作系统在读取页面后驱逐页面并预取下一个将要访问的连续页面。但这种方式也不是很完美：\nmadvise flag 只是 hint，操作系统可以自由忽略 向操作系统提供不恰当的 hint（例如，随机访问模式下使用 MADV_SEQUENTIAL）可能会对性能产生严重影响 还有一种办法是采用额外的后台线程 prefetch 这些可能访问的 page，尽可能 block 它们而不是主线程。不过这样的代码复杂度很高，违背了一开始因为简单而使用 mmap 的初心。\nError Handling 使用 mmap 时，DBMS 需要在每次访问页面时验证 checksum，因为操作系统可能会在上一次访问后的某个时间点透明地驱逐页面。而在传统的文件 IO 模式下，只需要在页面从文件中读取时验证 checksum 即可。\n使用 mmap 会导致损坏的页面被静默地持久化到文件中，这仍然是因为操作系统可能会透明地驱逐页面导致的。而在传统的文件 IO 模式下，可以在数据写入页面时进行一些约束检查以确保数据没有写坏。\n当使用 mmap 时，优雅地处理 I/O 错误变得更加困难，任何与 mmap 支持的内存交互的代码都可能产生 SIGBUS，DBMS 必须通过繁琐的信号处理程序来处理它们。\nPerformance Issues 基于 mmap 的文件 I/O 有三个关键性能瓶颈：page table 上的锁竞争、单线程页面驱逐、以及 TLB shootdown。作者认为 mmap 透明分页的最大缺点就是性能问题，如果没有操作系统级别的重新设计，这些问题无法避免。\n单线程页面驱逐：作者发现，对于高带宽二级存储设备（比如 PCIe 5.0 NVMe）上的大于内存的 DBMS 工作负载，操作系统的页面驱逐机制无法扩展到多线程上。可能之前的文件 I/O 带宽不高，这个性能问题没有暴露出来。\nTLB shootdowns：发生在页面驱逐期间，当前线程所在 CPU Core 需要使远程 Core 的 TLB 映射失效时。刷新本地 TLB 的成本很低，但发出处理器间中断以同步远程 TLB 可以花费数千个 CPU 周期。\nExperimental Analysis 使用 fio 测试 direct IO 的性能，硬件环境：\nAMD EPYC 7713 processor (64 cores, 128 hardware threads) 512 GB RAM, of which 100 GB was available to Linux (v5.11) for its page cache Samsung PM1733 SSD (rated with 7000 MB/s read and 3800 MB/s write throughput). Random Reads 随机读 2TB 的磁盘内容来模拟 larger than memory OLTP 负载，OS page cache 只有 100GB，这个场景理论上来说会有 95% 的 page fault。\n从测试结果来看，fio 基准测试表现稳定，每秒读取接近 900K 次，延迟和 NVMe 预期的 100us 差不多，说明 fio 已经充分利用里 NVMe SSD 的读能力。\nMADV_RANDOM 的表现非常不稳定：在前 27 秒内与 fio 初始表现相似，然后在大约五秒钟内降至接近 0，最后恢复到 fio 性能的一半。QPS 掉底是因为页面缓存已满，迫使操作系统开始从内存中逐出页面。右图 TLB shutdown 也能大致匹配上。\nTLB shootdown 信息可以在 /proc/interrupt 中观测到，TLB shootdown 开销大的原因有：\n发送一个处理器间中断来刷新每个核的 TLB 操作系统只使用一个进程（kswapd）来驱逐页面，在作者的实验中，该进程的 CPU 已经用满 操作系统必须同步页表，带来了极大的锁竞争开销 Sequential Scan 作者首先使用单个 SSD 运行了实验，然后在 10 个 SSD 上使用 RAID 0 重新运行了相同的工作负载（注：软件 RAID 0 是一种 RAID 0 的实现方式，它将两个或多个磁盘驱动器组合在一起，以提高读写速度。RAID 0 不提供数据冗余，因此如果其中一个驱动器出现故障，则所有数据都将丢失）：\n图 3，fio 可以利用一个 SSD 的全部带宽，同时保持稳定的性能 图 3，mmap 的性能最初与 fio 类似，但可以再次观察到，在大约 17 秒页面缓存填满后，性能急剧下降。此外，如预期的那样，对于这种工作负载，MADV_NORMAL 和 MADV_SEQUENTIAL 比 MADV_RANDOM 表现更好。 图 4，观察到 fio 和 mmap 之间的性能差异约为 20 倍，和图 3 使用单个 SSD 的结果相比也几乎没有性能提升。 Related Work 作者列举了几个使用 mmap 的研究方向，比如 failure-atomic msync、自己实现系统调用 kmmap 的 Tucana 和 Kreon，以及将 mmap 用在其他方面比如利用 mmap 将冷数据持久化到第二存储等。\n最后作者认为像 pointer swizzling 这样设计实现轻量级 buffer manager 才是正确的技术方向，其中两篇 paper 分别来自 TUM 继 Hyper 之后的新系统 LeanStore 和 Umbra，后面有时间详细研究下：\n《In-Memory Performance for Big Data》，2014，VLDB 《LeanStore: In-Memory Data Management beyond Main Memory》，2018，ICDE 《Umbra: A Disk-Based System with In-Memory Performance》，2020，CIDR ","wordCount":"4030","inLanguage":"en","datePublished":"2023-03-31T08:00:00Z","dateModified":"2023-03-31T08:00:00Z","author":{"@type":"Person","name":"Jian"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zz-jason.github.io/posts/cidr-2022-mmap-problems/"},"publisher":{"@type":"Organization","name":"Jian Zhang","logo":{"@type":"ImageObject","url":"https://zz-jason.github.io/favicon.ico"}}}</script></head><body id=top><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://zz-jason.github.io/ accesskey=h title="Jian Zhang (Alt + H)">Jian Zhang</a>
<span class=logo-switches></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://zz-jason.github.io/ title=Home><span>Home</span></a></li><li><a href=https://zz-jason.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://zz-jason.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://zz-jason.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>[CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System?</h1><div class=post-meta>March 31, 2023&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Jian</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#background aria-label=Background>Background</a><ul><li><a href=#mmap-overview aria-label="MMAP Overview">MMAP Overview</a></li><li><a href=#posix-api aria-label="POSIX API">POSIX API</a></li><li><a href=#mmap-gone-wrong aria-label="MMAP Gone Wrong">MMAP Gone Wrong</a></li></ul></li><li><a href=#problems-with-mmap aria-label="Problems With MMAP">Problems With MMAP</a><ul><li><a href=#transactional-safety aria-label="Transactional Safety">Transactional Safety</a><ul><li><a href=#os-copy-on-write aria-label="OS Copy-On-Write">OS Copy-On-Write</a></li><li><a href=#user-space-copy-on-write aria-label="User Space Copy-On-Write">User Space Copy-On-Write</a></li><li><a href=#shadow-paging aria-label="Shadow Paging">Shadow Paging</a></li></ul></li><li><a href=#io-stalls aria-label="I/O Stalls">I/O Stalls</a></li><li><a href=#error-handling aria-label="Error Handling">Error Handling</a></li><li><a href=#performance-issues aria-label="Performance Issues">Performance Issues</a></li></ul></li><li><a href=#experimental-analysis aria-label="Experimental Analysis">Experimental Analysis</a><ul><li><a href=#random-reads aria-label="Random Reads">Random Reads</a></li><li><a href=#sequential-scan aria-label="Sequential Scan">Sequential Scan</a></li></ul></li><li><a href=#related-work aria-label="Related Work">Related Work</a></li></ul></div></details></div><div class=post-content><p>依稀记得 CMU 有篇 paper 讲了使用 mmap 的各种问题，好奇之前大家使用 mmap 过程中遇到了哪些问题，于是抽空读了这篇论文，加深了我对数据存储、文件 IO 的理解。</p><h2 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h2><h3 id=mmap-overview>MMAP Overview<a hidden class=anchor aria-hidden=true href=#mmap-overview>#</a></h3><p><img src=https://raw.githubusercontent.com/zz-jason/blog-images/master/images/202304021532379.png alt="Figure 1: Step-by-step illustration of how a program accesses a file using mmap"></p><p>使用 mmap 读写文件内容的步骤：</p><ol><li>程序调用 mmap，得到指向内存映射文件内容的内存指针</li><li>操作系统保留程序的虚拟地址空间的一部分，但不加载文件的任何部分</li><li>程序使用指针访问文件的内容</li><li>操作系统尝试检索页面</li><li>由于指定的虚拟地址没有有效的映射，因此操作系统会触发 page fault，将文件的引用部分从磁盘加载到物理内存页中</li><li>操作系统向 page table 添加一个条目，将虚拟地址映射到新的物理地址</li><li>当前的 CPU Core 将此条目缓存在其本地的 TLB 中，以加速将来的数据访问</li></ol><p>Evict page 会出现一个叫 TLB Shootdown 的严重性能问题。操作系统需要从 page table 和每个 CPU Core 的 TLB 中删除它们的映射关系。清除触发中断的 CPU Core 的本地 TLB 很简单，但清除其他 CPU Core 上的 TLB 会很麻烦，因为当前 CPU 不为远端 TLB 提供一致性，操作系统必须发出昂贵的处理器间中断来刷新远端 CPU Core 的 TLB。从后面的实验结果能看到 TLB shootdown 会带来非常巨大的性能损失。</p><h3 id=posix-api>POSIX API<a hidden class=anchor aria-hidden=true href=#posix-api>#</a></h3><p><strong>mmap</strong>：这个调用会使操作系统将文件映射到 DBMS 的虚拟地址空间中，DBMS 可以使用普通的内存操作读写文件内容，通常使用下面两个 flag 来控制 update page 的行为：</p><ul><li>MAP_SHARED：操作系统会先将 page 缓存在内存中，由操作系统控制何时最终写回文件</li><li>MAP_PRIVATE：创建一个仅对调用者可访问的 copy-on-write 映射，page update 不会持久化到文件中。</li></ul><p><strong>madvise</strong>：使得 DBMS 可以向操作系统提供数据访问模式的 hint，可以是整个文件的粒度，也可以是特定 page 范围。《<a href=https://man7.org/linux/man-pages/man2/madvise.2.html>madvise(2) — Linux manual page</a>》 列举了完整的 hint 和它们对应的功能。论文描述了三个常用的 hint：MADV_NORMAL、MADV_RANDOM 和 MADV_SEQUENTIAL</p><ul><li>MADV_NORMAL：默认 hint，它会获取访问的 page，以及它前 15 个和后 16 个 page。对于 4KB 的 page，即使调用者只请求单个 page，也会导致操作系统从磁盘中读取总共 128KB 的数据</li><li>MADV_RANDOM：只读必要的页面，对于大于内存的 OLTP workload 来说是更好的选择。MADV_SEQUENTIAL：预读给定范围内的页面，访问后不久可能被释放，对于具有顺序扫描的OLAP workload 来说会更好。</li></ul><p><strong>mlock</strong>：使得 DBMS 可以将 page 固定在内存中，确保操作系统永远不会将它们 evict 出内存。不过即使 page 被固定在内存中，操作系统也可以随时将脏页（修改后的 page）刷到文件中。DBMS 不能使用 mlock 来保证脏页永远不被持久化，误用可能带来事务正确性问题。</p><p><strong>msync</strong>：显式地将指定的内存范围 flush 到文件。不显式调用 msync，DBMS 不能保证更新被持久化到文件中。</p><h3 id=mmap-gone-wrong>MMAP Gone Wrong<a hidden class=anchor aria-hidden=true href=#mmap-gone-wrong>#</a></h3><p><img src=https://raw.githubusercontent.com/zz-jason/blog-images/master/images/202304021619743.png alt="Table 1: Modern mmap-based DBMSs"></p><p>上面是一些使用过（比如 MongoDB），或正在使用 mmap 作为 buffer manager（比如 LevelDB），或提供 mmap 作为 buffer manager 选项（比如 WiredTiger）的 database，作者还举了 MongoDB、InfluxDB、SingleStore 等几个使用 mmap 遇到问题的案例，这些故事比较有意思，有时间可以详细了解下。</p><h2 id=problems-with-mmap>Problems With MMAP<a hidden class=anchor aria-hidden=true href=#problems-with-mmap>#</a></h2><p>主要是 4 个问题：transactional safety、I/O stalls、error handling，以及 performance issues。前面 3 个都能通过一些额外的稍显复杂的机制来解决或绕过，但性能问题除非修改操作系统内核代码否则无法有效避免。</p><h3 id=transactional-safety>Transactional Safety<a hidden class=anchor aria-hidden=true href=#transactional-safety>#</a></h3><p>核心问题是：由于透明分页，操作系统可以在任何时候将脏页刷新到二级存储器中，而不管写入事务是否已提交。DBMS 无法阻止这些刷新，并在其发生时也不会收到任何警告。</p><p>论文将解决办法分成了 3 种：OS copy-on-write、user space copy-on-write，以及 shadow paging。</p><h4 id=os-copy-on-write>OS Copy-On-Write<a hidden class=anchor aria-hidden=true href=#os-copy-on-write>#</a></h4><p>MongoDB 的 MMAPv1 存储引擎采用了这个策略。做法是：使用 mmap 和 MAP_PRIVATE flag 创建两个数据库文件副本，启用操作系统页面的写时复制功能，它们最初都指向相同的物理页面。第一个副本作为主副本，第二个副本则作为私有工作区供事务更新使用。当事务提交时，DBMS 将相应的 WAL 记录刷新到二级存储器，并使用单独的后台线程将提交的更改应用于主副本。</p><p>OS copy-on-write 的问题：</p><ol><li>在允许冲突事务运行之前，DBMS 必须确保提交的事务的最新更新已传播到主副本，这需要额外的 bookkeeping 来跟踪待更新的页面。</li><li>随着更新的不断发生，私有工作区将持续增长，DBMS 最终可能会在内存中拥有两个完整的数据库副本。也有办法来解决这个问题，只是实现比较复杂，也会引入额外性能开销，这里不再详细描述。</li></ol><h4 id=user-space-copy-on-write>User Space Copy-On-Write<a hidden class=anchor aria-hidden=true href=#user-space-copy-on-write>#</a></h4><p>SQLite、MonetDB 和 RavenDB 采用了这个策略，做法是手动将受影响的页面从 mmap 的内存复制到用户空间中一个单独维护的内存 buffer 内。 在处理更新操作时，DBMS 仅将数据更新应用于单独维护的内存副本并创建相应的 WAL 记录。写完 WAL 即可提交事务，同时也将副本的页面复制到mmap的内存中，交给操作系统去刷盘。</p><h4 id=shadow-paging>Shadow Paging<a hidden class=anchor aria-hidden=true href=#shadow-paging>#</a></h4><p>LMDB 基于 System R 的 shadow paging 设计采用了这种策略，做法是维护数据库的单独主副本和影子副本，这两个副本都由 mmap 支持。 处理更新操作时，DBMS 首先将受影响的页面从主副本复制到影子副本，然后应用更新操作。commit 更新操作需要使用 msync 将修改后的影子页面刷新到二级存储器，然后更新指针以将影子副本设置为新的主副本，原始主副本作为新的影子副本。</p><p>Shadow paging 需要注意的地方：必须确保事务不会冲突或看到部分更新。例如，LMDB 通过仅允许单个写入者来解决此问题。</p><h3 id=io-stalls>I/O Stalls<a hidden class=anchor aria-hidden=true href=#io-stalls>#</a></h3><p>mmap 不支持异步读取。因为 DBMS 无法知道页面是否在内存中，如果访问到已经驱逐的页面就会导致意外的 I/O 停顿。这一点和传统的 buffer manager 可以使用 libaio、io_uring 异步读写页面有很大不同。</p><p>如何避免呢，其中一个思路是使用 mlock：用 mlock 来固定 DBMS 在不久的将来希望再次访问的页面。但使用 mlock 也是有限制的，因为固定太多页面可能会对并发运行的进程甚至操作系统本身造成一些严重问题，操作系统通常限制单个进程可以锁定的内存量。在这个限制下使用 mlock，DBMS 还需要仔细跟踪和取消固定不再使用的页面，以便操作系统可以驱逐它们。</p><p>另一种思路是通过 madvise 告诉操作系统查询的读写模式。例如，需要执行顺序扫描的 DBMS 可以向 madvise 提供 MADV_SEQUENTIAL flag，告诉操作系统在读取页面后驱逐页面并预取下一个将要访问的连续页面。但这种方式也不是很完美：</p><ol><li>madvise flag 只是 hint，操作系统可以自由忽略</li><li>向操作系统提供不恰当的 hint（例如，随机访问模式下使用 MADV_SEQUENTIAL）可能会对性能产生严重影响</li></ol><p>还有一种办法是采用额外的后台线程 prefetch 这些可能访问的 page，尽可能 block 它们而不是主线程。不过这样的代码复杂度很高，违背了一开始因为简单而使用 mmap 的初心。</p><h3 id=error-handling>Error Handling<a hidden class=anchor aria-hidden=true href=#error-handling>#</a></h3><p>使用 mmap 时，DBMS 需要在每次访问页面时验证 checksum，因为操作系统可能会在上一次访问后的某个时间点透明地驱逐页面。而在传统的文件 IO 模式下，只需要在页面从文件中读取时验证 checksum 即可。</p><p>使用 mmap 会导致损坏的页面被静默地持久化到文件中，这仍然是因为操作系统可能会透明地驱逐页面导致的。而在传统的文件 IO 模式下，可以在数据写入页面时进行一些约束检查以确保数据没有写坏。</p><p>当使用 mmap 时，优雅地处理 I/O 错误变得更加困难，任何与 mmap 支持的内存交互的代码都可能产生 SIGBUS，DBMS 必须通过繁琐的信号处理程序来处理它们。</p><h3 id=performance-issues>Performance Issues<a hidden class=anchor aria-hidden=true href=#performance-issues>#</a></h3><p>基于 mmap 的文件 I/O 有三个关键性能瓶颈：<strong>page table 上的锁竞争、单线程页面驱逐、以及 TLB shootdown</strong>。作者认为 mmap 透明分页的最大缺点就是性能问题，如果没有操作系统级别的重新设计，这些问题无法避免。</p><p>单线程页面驱逐：作者发现，对于高带宽二级存储设备（比如 PCIe 5.0 NVMe）上的大于内存的 DBMS 工作负载，操作系统的页面驱逐机制无法扩展到多线程上。可能之前的文件 I/O 带宽不高，这个性能问题没有暴露出来。</p><p>TLB shootdowns：发生在页面驱逐期间，当前线程所在 CPU Core 需要使远程 Core 的 TLB 映射失效时。刷新本地 TLB 的成本很低，但发出处理器间中断以同步远程 TLB 可以花费数千个 CPU 周期。</p><h2 id=experimental-analysis>Experimental Analysis<a hidden class=anchor aria-hidden=true href=#experimental-analysis>#</a></h2><p>使用 fio 测试 direct IO 的性能，硬件环境：</p><ul><li>AMD EPYC 7713 processor (64 cores, 128 hardware threads)</li><li>512 GB RAM, of which 100 GB was available to Linux (v5.11) for its page cache</li><li>Samsung PM1733 SSD (rated with 7000 MB/s read and 3800 MB/s write throughput).</li></ul><h3 id=random-reads>Random Reads<a hidden class=anchor aria-hidden=true href=#random-reads>#</a></h3><p><img src=https://raw.githubusercontent.com/zz-jason/blog-images/master/images/202304021447281.png alt="Figure 2: Random Reads - 1 SSD (100 threads)"></p><p>随机读 2TB 的磁盘内容来模拟 larger than memory OLTP 负载，OS page cache 只有 100GB，这个场景理论上来说会有 95% 的 page fault。</p><p>从测试结果来看，fio 基准测试表现稳定，每秒读取接近 900K 次，延迟和 NVMe 预期的 100us 差不多，说明 fio 已经充分利用里 NVMe SSD 的读能力。</p><p>MADV_RANDOM 的表现非常不稳定：在前 27 秒内与 fio 初始表现相似，然后在大约五秒钟内降至接近 0，最后恢复到 fio 性能的一半。QPS 掉底是因为页面缓存已满，迫使操作系统开始从内存中逐出页面。右图 TLB shutdown 也能大致匹配上。</p><p>TLB shootdown 信息可以在 /proc/interrupt 中观测到，TLB shootdown 开销大的原因有：</p><ol><li>发送一个处理器间中断来刷新每个核的 TLB</li><li>操作系统只使用一个进程（kswapd）来驱逐页面，在作者的实验中，该进程的 CPU 已经用满</li><li>操作系统必须同步页表，带来了极大的锁竞争开销</li></ol><h3 id=sequential-scan>Sequential Scan<a hidden class=anchor aria-hidden=true href=#sequential-scan>#</a></h3><p><img src=https://raw.githubusercontent.com/zz-jason/blog-images/master/images/202304021518321.jpg alt="Fiture 3 & Figure 4: Sequential Scan"></p><p>作者首先使用单个 SSD 运行了实验，然后在 10 个 SSD 上使用 RAID 0 重新运行了相同的工作负载（注：软件 RAID 0 是一种 RAID 0 的实现方式，它将两个或多个磁盘驱动器组合在一起，以提高读写速度。RAID 0 不提供数据冗余，因此如果其中一个驱动器出现故障，则所有数据都将丢失）：</p><ul><li>图 3，fio 可以利用一个 SSD 的全部带宽，同时保持稳定的性能</li><li>图 3，mmap 的性能最初与 fio 类似，但可以再次观察到，在大约 17 秒页面缓存填满后，性能急剧下降。此外，如预期的那样，对于这种工作负载，MADV_NORMAL 和 MADV_SEQUENTIAL 比 MADV_RANDOM 表现更好。</li><li>图 4，观察到 fio 和 mmap 之间的性能差异约为 20 倍，和图 3 使用单个 SSD 的结果相比也几乎没有性能提升。</li></ul><h2 id=related-work>Related Work<a hidden class=anchor aria-hidden=true href=#related-work>#</a></h2><p>作者列举了几个使用 mmap 的研究方向，比如 failure-atomic msync、自己实现系统调用 kmmap 的 Tucana 和 Kreon，以及将 mmap 用在其他方面比如利用 mmap 将冷数据持久化到第二存储等。</p><p>最后作者认为像 pointer swizzling 这样设计实现轻量级 buffer manager 才是正确的技术方向，其中两篇 paper 分别来自 TUM 继 Hyper 之后的新系统 LeanStore 和 Umbra，后面有时间详细研究下：</p><ul><li>《In-Memory Performance for Big Data》，2014，VLDB</li><li>《LeanStore: In-Memory Data Management beyond Main Memory》，2018，ICDE</li><li>《Umbra: A Disk-Based System with In-Memory Performance》，2020，CIDR</li></ul></div><footer class=post-footer><nav class=paginav><a class=prev href=https://zz-jason.github.io/posts/cidr-2020-umbra/><span class=title>« Prev Page</span><br><span>[CIDR 2020] Umbra: A Disk-Based System with In-Memory Performance</span></a>
<a class=next href=https://zz-jason.github.io/posts/readings-storage.md/><span class=title>Next Page »</span><br><span>Essential Readings on Database Storage</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on twitter" href="https://twitter.com/intent/tweet/?text=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f&url=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f&title=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f&summary=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f&source=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f&title=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on whatsapp" href="https://api.whatsapp.com/send?text=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f%20-%20https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [CIDR 2022] Are You Sure You Want to Use MMAP in Your Database Management System? on telegram" href="https://telegram.me/share/url?text=%5bCIDR%202022%5d%20Are%20You%20Sure%20You%20Want%20to%20Use%20MMAP%20in%20Your%20Database%20Management%20System%3f&url=https%3a%2f%2fzz-jason.github.io%2fposts%2fcidr-2022-mmap-problems%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=zz-jason/zz-jason.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://zz-jason.github.io/>Jian Zhang</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById("menu").scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById("menu").scrollLeft)}</script></body></html>